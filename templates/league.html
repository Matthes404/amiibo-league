{% extends 'base.html' %}
{% block content %}
<h1>Leagues</h1>
{% for lg, players, rounds in leagues %}
<h2>League {{ lg }}</h2>
<table class="standings">
  <tr><th>Name</th><th>Score</th><th>Diff</th><th>Wins</th><th>SB</th></tr>
  {% for p, sc, diff, wins, sb in players %}
  <tr>
    <td>{{ p.name }}</td>
    <td>{{ sc }}</td>
    <td>{{ diff }}</td>
    <td>{{ wins }}</td>
    <td>{{ sb }}</td>
  </tr>
  {% endfor %}
</table>
<div class="round-tabs">
  <div class="tab-links">
    {% for rnd, _ in rounds %}
      <button type="button"
              class="tab-link{% if loop.first %} active{% endif %}"
              data-target="lg{{ lg }}-round{{ rnd }}">Round {{ rnd }}</button>
    {% endfor %}
  </div>
  {% for rnd, matches in rounds %}
  <div id="lg{{ lg }}-round{{ rnd }}" class="tab-content{% if not loop.first %} hidden{% endif %}">
    <table class="bracket">
      <tr><th>Player 1</th><th>Player 2</th><th>Winner</th></tr>
      {% for m in matches %}
      <tr>
        <td>{{ m[0].name }}</td>
        <td>{{ m[1].name }}</td>
        <td>
          {% if m[2] %}
            {% if m[2] == 'Draw' %}
              Draw
            {% else %}
              {{ m[2].name }}
            {% endif %}
          {% else %}
            <form method="post" action="/report_league_result">
                <input type="hidden" name="league" value="{{ lg }}">
                <input type="hidden" name="player1" value="{{ m[0].id }}">
                <input type="hidden" name="player2" value="{{ m[1].id }}">
                <input type="hidden" name="round" value="{{ rnd }}">
                <input type="number" name="score1" min="0" required>
                <input type="number" name="score2" min="0" required>
                <button type="submit">Submit</button>
            </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </table>
  </div>
  {% endfor %}
</div>
{% endfor %}
<form method="post" action="/finish_league">
    <button type="submit">Finish League</button>
</form>
<script>
document.querySelectorAll('.round-tabs').forEach(function(tabs){
  tabs.querySelectorAll('.tab-link').forEach(function(btn){
    btn.addEventListener('click', function(){
      const target = this.dataset.target;
      tabs.querySelectorAll('.tab-content').forEach(function(tc){ tc.classList.add('hidden'); });
      tabs.querySelectorAll('.tab-link').forEach(function(b){ b.classList.remove('active'); });
      tabs.querySelector('#'+target).classList.remove('hidden');
      this.classList.add('active');
    });
  });
});
</script>
{% endblock %}
